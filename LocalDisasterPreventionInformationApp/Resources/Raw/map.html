<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Leaflet Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // 地図の初期表示（日本の中心あたり）
        var map = L.map('map').setView([35.0, 135.0], 5);

        window.mapReady = false;

        // OpenStreetMap タイル
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
            maxZoom: 19
        }).addTo(map);

        window.mapReady = true;

        // C# から呼ばれる関数
        function drawRoute(coords) {
            // coords は [ [lon,lat], [lon,lat], ... ] の形式
            var latlngs = coords.map(c => [c[1], c[0]]); // Leaflet は [lat,lon]

            // ルート描画
            var polyline = L.polyline(latlngs, { color: 'red', weight: 4 }).addTo(map);

            // 地図をルートに合わせる
            map.fitBounds(polyline.getBounds());
        }

        var currentLocationMarker = null;

        // 現在地を中心にする
        function setCurrentLocation(lat, lng) {
            window.currentLat = lat;
            window.currentLng = lng;

            // 地図の中心を現在地に移動
            map.setView([lat, lng], 15);

            // 既存の現在地マーカーを削除
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }

            // 現在地マーカー（赤い〇）
            currentLocationMarker = L.circleMarker([lat, lng], {
                radius: 8,
                color: 'red',
                fillColor: 'red',
                fillOpacity: 0.8
            }).addTo(map).bindPopup("現在地");
        }

        var prefectureMarkers = [];
        var nearbyMarkers = [];

        // 避難所ピンを表示
        function addShelterMarkers(shelters) {
            // 既存の都道府県ピンを削除
            prefectureMarkers.forEach(m => map.removeLayer(m));
            prefectureMarkers = [];

            // 現在地付近の10件ピンを削除
            nearbyMarkers.forEach(m => map.removeLayer(m));
            nearbyMarkers = [];

            var latlngs = [];

            shelters.forEach(s => {
                var marker = L.marker([s.Latitude, s.Longitude]).addTo(map);

                // 都道府県ピンとして保存
                prefectureMarkers.push(marker);

                latlngs.push([s.Latitude, s.Longitude]);

                // クリック時の処理(エラー防止)
                marker.on('click', function () { });
            });

            // ピンがある範囲に地図を合わせる
            if (latlngs.length > 0) {
                var bounds = L.latLngBounds(latlngs);
                map.fitBounds(bounds);
            }
        }

        // 指定した避難所へ移動＋ズーム
        function moveToShelter(lat, lng) {
            map.setView([lat, lng], 17);
        }

        // 初期10件ピン追加
        function addNearbyMarkers(shelters) {
            // 初期10件は毎回消して書き直す
            nearbyMarkers.forEach(m => map.removeLayer(m));
            nearbyMarkers = [];

            shelters.forEach(s => {
                var marker = L.marker([s.Latitude, s.Longitude]).addTo(map);
                nearbyMarkers.push(marker);
            });
        }

        // 都道府県ピンを削除
        function clearPrefectureMarkers() {
            prefectureMarkers.forEach(m => map.removeLayer(m));
            prefectureMarkers = [];
        }

        // ルート描画
        var routeControl = null;

        function showRoute(fromLat, fromLng, toLat, toLng, mode) {

            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }

            // OSRM 正式プロファイル
            var profile =
                mode === "driving" ? "driving" :
                    mode === "bicycling" ? "cycling" :
                        mode === "walking" ? "walking" :
                            "driving";

            // OSRM API URL
            var url = `https://router.project-osrm.org/route/v1/${profile}/${fromLng},${fromLat};${toLng},${toLat}?overview=full&geometries=geojson`;

            fetch(url)
                .then(r => r.json())
                .then(json => {
                    if (!json.routes || json.routes.length === 0) {
                        console.error("No route found");
                        return;
                    }

                    var coords = json.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);

                    // ルート線を描画
                    routeControl = L.polyline(coords, {
                        color: 'red',
                        weight: 5,
                        opacity: 1
                    }).addTo(map);

                    // ルート全体が見えるように調整
                    map.fitBounds(routeControl.getBounds());
                })
                .catch(err => console.error(err));
        }

        // 現在地からルート検索
        function showRouteFromCurrent(toLat, toLng, mode) {
            if (!window.currentLat || !window.currentLng) {
                console.error("現在地が未設定です");
                return;
            }

            showRoute(window.currentLat, window.currentLng, toLat, toLng, mode);
        }

        // ルート削除
        function clearRoute() {
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
        }
    </script>
</body>
</html>