<ContentPage
    x:Class="LocalDisasterPreventionInformationApp.Pages.Stock.StockPage"
    x:Name="ThisPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:base="clr-namespace:LocalDisasterPreventionInformationApp.Pages.Base"
    Shell.NavBarIsVisible="False">

    <base:BasePage>
        <base:BasePage.InnerContent>
            <Grid x:Name="Inner" BindingContext ="{x:Reference ThisPage}"
                  RowDefinitions="Auto,Auto,*,Auto"
                  Padding="10">
                <!-- 期限が近い商品 -->
                <VerticalStackLayout Grid.Row="0"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Start"
                                     Spacing="4">
                    <BindableLayout.ItemsSource>
                        <Binding Path="ExpiringItems"/>
                    </BindableLayout.ItemsSource>

                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <Label Text="{Binding Message}"
                                   TextColor="Red"
                                   FontSize="16"
                                   Margin="0,2"
                                   HorizontalOptions="Center"/>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

                <!-- 並べ替え -->
                <Grid Grid.Row="1" ColumnDefinitions="*,Auto" Margin="0,10">
                    <Label Text="{Binding SelectedSortName}"
                           VerticalOptions="Center"
                           FontSize="18"/>
                    <Picker x:Name="SortPicker"
                            Grid.Column="1"
                            Title="並べ替え"
                            WidthRequest="150"
                            SelectedIndexChanged="OnSortChanged">
                        <Picker.Items>
                            <x:String>商品名</x:String>
                            <x:String>カテゴリ</x:String>
                            <x:String>消費期限</x:String>
                        </Picker.Items>
                    </Picker>
                </Grid>

                <!-- 商品一覧 -->
                <CollectionView Grid.Row="2"
                                ItemsSource="{Binding Items}"
                                HorizontalOptions="Center"
                                WidthRequest="900">
                    <CollectionView.Header>
                        <VerticalStackLayout Spacing="0">

                            <!-- ヘッダー行 -->
                            <Grid ColumnDefinitions="150,230,230,200,90" Padding="5" BackgroundColor="#EEEEEE">
                                <Label Grid.Column="0" Text="商品名" FontAttributes="Bold" HorizontalOptions="Center"/>
                                <Label Grid.Column="1" Text="数量" FontAttributes="Bold" HorizontalOptions="Center" />
                                <Label Grid.Column="2" Text="消費期限" FontAttributes="Bold" HorizontalOptions="Center" />
                                <Label Grid.Column="3" Text="カテゴリ" FontAttributes="Bold" HorizontalOptions="Center" />
                                <Label Grid.Column="4" Text="削除" FontAttributes="Bold" HorizontalOptions="Center" />
                            </Grid>

                            <!-- ★ 黒い線（1px） -->
                            <BoxView HeightRequest="1" BackgroundColor="Black" HorizontalOptions="Fill" />
                        </VerticalStackLayout>
                    </CollectionView.Header>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <VerticalStackLayout Spacing="0">
                                <Grid ColumnDefinitions="150,230,230,200,90" Padding="5">
                                    <!-- ★ 縦線（商品名と数量の間） -->
                                    <BoxView Grid.Column="1"
                                        WidthRequest="1"
                                        BackgroundColor="#CCCCCC"
                                        HorizontalOptions="Start"
                                        VerticalOptions="Fill"/>

                                    <!-- ★ 縦線（数量と消費期限の間） -->
                                    <BoxView Grid.Column="2"
                                        WidthRequest="1"
                                        BackgroundColor="#CCCCCC"
                                        HorizontalOptions="Start"
                                        VerticalOptions="Fill"/>

                                    <!-- ★ 縦線（消費期限とカテゴリの間） -->
                                    <BoxView Grid.Column="3"
                                        WidthRequest="1"
                                        BackgroundColor="#CCCCCC"
                                        HorizontalOptions="Start"
                                        VerticalOptions="Fill"/>

                                    <!-- ★ 縦線（カテゴリと削除の間） -->
                                    <BoxView Grid.Column="4"
                                        WidthRequest="1"
                                        BackgroundColor="#CCCCCC"
                                        HorizontalOptions="Start"
                                        VerticalOptions="Fill"/>

                                    <!-- 商品名 -->
                                    <Label Grid.Column="0" Text="{Binding ProductName}" VerticalOptions="Center" HorizontalOptions="Center"/>
                                    <!-- 数量＋増減ボタン（横並びでコンパクト） -->
                                    <Grid Grid.Column="1"
                                        ColumnDefinitions="100,30,100"
                                        HorizontalOptions="Center"
                                        ColumnSpacing="4">

                                        <!-- －ボタン -->
                                        <Border Grid.Column="0"
                                            WidthRequest="24"
                                            HeightRequest="24"
                                            Padding="0"
                                            BackgroundColor="White"
                                            Stroke="Black"
                                            StrokeThickness="1"    
                                            StrokeShape="RoundRectangle 4">

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={x:Reference ThisPage},Path=DecreaseCommand}"
                                                    CommandParameter="{Binding}"/>
                                            </Border.GestureRecognizers>

                                            <Label Text="－"
                                                FontSize="20"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                HorizontalTextAlignment="Center"
                                                VerticalTextAlignment="Center"/>
                                        </Border>

                                        <!-- 数量 -->
                                        <Label Grid.Column="1"
                                        Text="{Binding Quantity}"
                                        VerticalOptions="Center"
                                        HorizontalOptions="Center"
                                        Margin="4,0"/>

                                        <!-- ＋ボタン -->
                                        <Border Grid.Column="2"
                                            WidthRequest="24"
                                            HeightRequest="24"
                                            Padding="0"
                                            BackgroundColor="White"
                                            Stroke="Black"
                                            StrokeThickness="1"
                                            StrokeShape="RoundRectangle 4">

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={x:Reference ThisPage},Path=IncreaseCommand}"
                                                    CommandParameter="{Binding}"/>
                                            </Border.GestureRecognizers>

                                            <Label Text="＋"
                                                FontSize="20"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                HorizontalTextAlignment="Center"
                                                VerticalTextAlignment="Center"/>
                                        </Border>
                                    </Grid>

                                    <Label Grid.Column="2" Text="{Binding ExpireDate}" VerticalOptions="Center" HorizontalOptions="Center"/>

                                    <!-- カテゴリ -->
                                    <Label Grid.Column="3" Text="{Binding Category}" VerticalOptions="Center" HorizontalOptions="Center"/>

                                    <!-- 削除ボタン -->
                                    <ImageButton Grid.Column="4"
                                         Source="delete.png"
                                         WidthRequest="30"
                                         HeightRequest="30"
                                         Command="{Binding Source={x:Reference ThisPage}, Path=DeleteCommand}"
                                         CommandParameter="{Binding}"/>
                                    </Grid>

                                <!-- 商品間の区切り線 -->
                                <BoxView HeightRequest="0.5"
                                         BackgroundColor="Black"
                                         HorizontalOptions="Fill"/>
                            </VerticalStackLayout>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- 登録ボタン -->
                <Grid Grid.Row="3">
                    <Button Text="商品登録➔"
                            HorizontalOptions="End"
                            WidthRequest="120"
                            Margin="0,10,0,0"
                            Clicked="OnRegisterClicked"/>
                </Grid>
            </Grid>
        </base:BasePage.InnerContent>
    </base:BasePage>
</ContentPage>